# Deployment Guide - new.kavi.cz

N√°vod pro nasazen√≠ nov√© verze Kavi projektu na Hostinger VPS server jako subdom√©na `new.kavi.cz`.

## üìã P≈ôehled

- **C√≠lov√° dom√©na:** new.kavi.cz (staging)
- **Fin√°ln√≠ dom√©na:** kavi.cz (po √∫spƒõ≈°n√©m testov√°n√≠)
- **Server:** Hostinger VPS s SSH root p≈ô√≠stupem
- **Existuj√≠c√≠ projekty:** kavi.cz (WordPress) + dal≈°√≠ Laravel projekty - MUS√ç z≈Østat nedotƒçeny!
- **Stack:** Laravel 10, PHP 8.2+, MySQL, Nginx, Node.js

---

## ‚ö†Ô∏è D≈ÆLE≈ΩIT√â - Multi-project server

**Pokud na serveru u≈æ bƒõ≈æ√≠ jin√© projekty, buƒè VELMI opatrn√Ω!**

### Co NIKDY nedƒõlat:
- ‚ùå Nemƒõ≈à glob√°ln√≠ PHP konfiguraci (`php.ini`) bez anal√Ωzy dopad≈Ø na ostatn√≠ projekty
- ‚ùå Neupgraduj PHP verzi bez konzultace s ostatn√≠mi projekty
- ‚ùå Nerestaruj slu≈æby bez nutnosti
- ‚ùå Nemƒõ≈à MySQL konfiguraci bez d≈Økladn√©ho zv√°≈æen√≠
- ‚ùå Nema≈æej ≈æ√°dn√© existuj√≠c√≠ adres√°≈ôe nebo konfigurace

### Co dƒõlat:
- ‚úÖ Vytvo≈ô izolovan√Ω adres√°≈ô pro Kavi (`/var/www/new.kavi.cz`)
- ‚úÖ Pou≈æ√≠vej separ√°tn√≠ Nginx konfiguraci
- ‚úÖ Vytvo≈ô samostatnou datab√°zi
- ‚úÖ Pou≈æ√≠vej stejnou PHP verzi jako ostatn√≠ projekty (nebo vy≈°≈°√≠, pokud je kompatibiln√≠)
- ‚úÖ Testuj na staging prost≈ôed√≠ (new.kavi.cz) p≈ôed jak√Ωmikoli zmƒõnami

---

## üöÄ F√°ze 1: P≈ô√≠prava serveru - Multi-project bezpeƒçn√Ω setup

### 1.1 P≈ôipojen√≠ na server

```bash
ssh root@your-server-ip
```

### 1.2 Kontrola existuj√≠c√≠ho prost≈ôed√≠

**üîç NEJD≈ò√çV ZJISTI, CO U≈Ω NA SERVERU Bƒö≈Ω√ç!**

```bash
# Zkontroluj existuj√≠c√≠ projekty
ls -la /var/www/

# Zkontroluj aktu√°ln√≠ PHP verzi
php -v
php-fpm -v  # nebo php8.1-fpm -v, php8.2-fpm -v atd.

# Zkontroluj bƒõ≈æ√≠c√≠ PHP-FPM verze
systemctl list-units | grep php

# Zkontroluj existuj√≠c√≠ Nginx konfigurace
ls -la /etc/nginx/sites-enabled/

# Zkontroluj MySQL/MariaDB
mysql --version
systemctl status mysql || systemctl status mariadb

# Zkontroluj datab√°ze
mysql -u root -p -e "SHOW DATABASES;"

# Zkontroluj disk space
df -h

# Zkontroluj RAM
free -h
```

**üìù Poznamenej si:**
- Jak√© projekty u≈æ bƒõ≈æ√≠ a v jak√Ωch slo≈æk√°ch
- Jakou PHP verzi pou≈æ√≠vaj√≠ existuj√≠c√≠ projekty
- Jak√© datab√°ze u≈æ existuj√≠
- Kolik voln√©ho m√≠sta m√°≈° k dispozici

### 1.3 Aktualizace syst√©mu (OPATRNƒö!)

```bash
# Aktualizuj bal√≠ƒçky, ale NERESTARUJ slu≈æby automaticky
apt update

# Zkontroluj, co by se aktualizovalo
apt list --upgradable

# Pokud tam nen√≠ nic kritick√©ho (PHP, MySQL), m≈Ø≈æe≈° upgradovat
apt upgrade -y

# NEBO bezpeƒçnƒõj≈°√≠ varianta - aktualizuj jen security updaty
apt upgrade -y --with-new-pkgs
```

### 1.4 Instalace po≈æadovan√©ho software (KONTROLUJ P≈òED INSTALAC√ç!)

#### PHP 8.2 a roz≈°√≠≈ôen√≠

**‚ö†Ô∏è POZOR: Pokud ostatn√≠ projekty bƒõ≈æ√≠ na PHP 7.x nebo 8.0/8.1, NESTAHUJ je!**

```bash
# Nejd≈ô√≠v zkontroluj, jak√° PHP verze je nainstalovan√°
php -v
dpkg -l | grep php

# Pokud je PHP 8.2 u≈æ nainstalovan√©, p≈ôeskoƒç instalaci
# Pokud je PHP 8.1, m≈Ø≈æe≈° nainstalovat 8.2 VEDLE (nenahrazuje 8.1)
# Pokud je star≈°√≠ verze (7.x), ZVA≈ΩUJ upgrade nebo pou≈æij existuj√≠c√≠ verzi

# Instalace PHP 8.2 VEDLE existuj√≠c√≠ verze (neru≈°√≠ starou)
apt install software-properties-common -y
add-apt-repository ppa:ondrej/php -y
apt update

# Instalace PHP 8.2 - NEOVLIVN√ç existuj√≠c√≠ PHP verze
apt install -y php8.2 php8.2-fpm php8.2-cli php8.2-common php8.2-mysql \
  php8.2-zip php8.2-gd php8.2-mbstring php8.2-curl php8.2-xml \
  php8.2-bcmath php8.2-sqlite3 php8.2-redis

# Ovƒõ≈ôen√≠ - mƒõly by bƒõ≈æet OBOJE verze vedle sebe
php -v  # Uk√°≈æe v√Ωchoz√≠ verzi
php8.2 -v  # Uk√°≈æe konkr√©tnƒõ 8.2
systemctl status php8.2-fpm  # Mƒõlo by bƒõ≈æet

# Pokud mƒõly bƒõ≈æet i jin√© verze, zkontroluj, ≈æe st√°le bƒõ≈æ√≠
systemctl status php8.1-fpm  # Pokud m√°≈° 8.1
systemctl status php7.4-fpm  # Pokud m√°≈° 7.4
```

#### Composer

```bash
# Zkontroluj, jestli u≈æ nen√≠ nainstalovan√Ω
composer --version

# Pokud nen√≠, nainstaluj
if ! command -v composer &> /dev/null; then
    cd /tmp
    curl -sS https://getcomposer.org/installer -o composer-setup.php
    php composer-setup.php --install-dir=/usr/local/bin --filename=composer
    composer --version
else
    echo "‚úÖ Composer je u≈æ nainstalovan√Ω"
fi
```

#### Node.js a npm (pro Vite build)

```bash
# Zkontroluj existuj√≠c√≠ instalaci
node -v
npm -v

# Pokud nen√≠ nainstalovan√Ω nebo je verze < 18, nainstaluj
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt install -y nodejs
    node -v
    npm -v
else
    echo "‚úÖ Node.js je u≈æ nainstalovan√Ω: $(node -v)"
fi
```

#### MySQL (pokud je≈°tƒõ nen√≠ nainstalov√°n)

```bash
# Zkontroluj, jestli u≈æ bƒõ≈æ√≠
systemctl status mysql || systemctl status mariadb

# Pokud ne, nainstaluj (ALE pravdƒõpodobnƒõ u≈æ m√°≈°, pokud bƒõ≈æ√≠ jin√© projekty!)
if ! systemctl is-active --quiet mysql && ! systemctl is-active --quiet mariadb; then
    apt install mysql-server -y
    mysql_secure_installation
else
    echo "‚úÖ MySQL/MariaDB u≈æ bƒõ≈æ√≠"
fi
```

#### Vytvo≈ôen√≠ samostatn√© datab√°ze pro Kavi

**‚ö†Ô∏è D≈ÆLE≈ΩIT√â: Vytvo≈ô NOVOU datab√°zi a NOV√âHO u≈æivatele!**  
**NIKDY nepou≈æ√≠vej existuj√≠c√≠ datab√°ze jin√Ωch projekt≈Ø!**

```bash
# P≈ôipoj se k MySQL
mysql -u root -p
```

V MySQL konzoli:

```sql
-- Zkontroluj existuj√≠c√≠ datab√°ze (abys nep≈ôepsal nƒõco d≈Øle≈æit√©ho)
SHOW DATABASES;

-- Zkontroluj existuj√≠c√≠ u≈æivatele
SELECT User, Host FROM mysql.user;

-- Vytvo≈ô NOVOU datab√°zi pro Kavi
CREATE DATABASE kavi_new CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Vytvo≈ô NOV√âHO u≈æivatele s SILN√ùM heslem
CREATE USER 'kavi_user'@'localhost' IDENTIFIED BY 'very-Strong-P@ssw0rd-2024!';

-- Dej mu opr√°vnƒõn√≠ JEN k datab√°zi kavi_new (ne k ostatn√≠m!)
GRANT ALL PRIVILEGES ON kavi_new.* TO 'kavi_user'@'localhost';

-- Aplikuj zmƒõny
FLUSH PRIVILEGES;

-- Ovƒõ≈ô, ≈æe to funguje
USE kavi_new;
SELECT DATABASE();

EXIT;
```

**Testov√°n√≠ p≈ôipojen√≠:**
```bash
# Otestuj, ≈æe nov√Ω u≈æivatel se m≈Ø≈æe p≈ôipojit
mysql -u kavi_user -p kavi_new
# Zadej heslo, mƒõlo by tƒõ to pustit dovnit≈ô
# Pak EXIT;
```

#### Nginx (pokud je≈°tƒõ nen√≠ nainstalov√°n)

```bash
# Zkontroluj status
systemctl status nginx

# Pokud nebƒõ≈æ√≠, nainstaluj
if ! systemctl is-active --quiet nginx; then
    apt install nginx -y
    systemctl start nginx
    systemctl enable nginx
else
    echo "‚úÖ Nginx u≈æ bƒõ≈æ√≠"
fi
```

---

## üóÇÔ∏è F√°ze 2: Nahr√°n√≠ projektu

### 2.1 Vytvo≈ôen√≠ adres√°≈ôov√© struktury

```bash
# Vytvo≈ôen√≠ hlavn√≠ho adres√°≈ôe pro nov√Ω projekt
mkdir -p /var/www/new.kavi.cz
cd /var/www/new.kavi.cz
```

### 2.2 Nahr√°n√≠ k√≥du

**Varianta A: P≈ôes Git (doporuƒçeno)**

```bash
# Na serveru
cd /var/www/new.kavi.cz
git clone https://github.com/your-username/kavi.git .
# nebo pokud pou≈æ√≠v√°≈° priv√°tn√≠ repo, bude≈° pot≈ôebovat SSH kl√≠ƒç
```

**Varianta B: P≈ôes SCP (z tv√©ho lok√°ln√≠ho poƒç√≠taƒçe)**

```bash
# Z lok√°ln√≠ho poƒç√≠taƒçe
cd /Users/lukas/Kavi

# Vytvo≈ô tarball (vynech√° node_modules, vendor, atd.)
tar --exclude='node_modules' \
    --exclude='vendor' \
    --exclude='storage/logs/*' \
    --exclude='storage/framework/cache/*' \
    --exclude='storage/framework/sessions/*' \
    --exclude='storage/framework/views/*' \
    --exclude='.git' \
    --exclude='database/database.sqlite' \
    -czf kavi-new.tar.gz .

# Nahraj na server
scp kavi-new.tar.gz root@your-server-ip:/var/www/new.kavi.cz/

# Na serveru rozbal
ssh root@your-server-ip
cd /var/www/new.kavi.cz
tar -xzf kavi-new.tar.gz
rm kavi-new.tar.gz
```

**Varianta C: P≈ôes SFTP/FileZilla**
- P≈ôipoj se k serveru p≈ôes SFTP
- Nahraj v≈°echny soubory do `/var/www/new.kavi.cz/`
- **Vynech:** `node_modules/`, `vendor/`, `.git/`, `database/database.sqlite`

---

## ‚öôÔ∏è F√°ze 3: Konfigurace projektu

### 3.1 Instalace z√°vislost√≠

```bash
cd /var/www/new.kavi.cz

# PHP z√°vislosti
composer install --optimize-autoloader --no-dev

# JavaScript z√°vislosti a build
npm install
npm run build
```

### 3.2 Konfigurace .env

```bash
cd /var/www/new.kavi.cz
cp ENV_EXAMPLE_CONTENT.txt .env
nano .env
```

Upravit tyto kl√≠ƒçov√© hodnoty:

```env
APP_NAME=Kavi
APP_ENV=production
APP_KEY=
APP_DEBUG=false
APP_URL=https://new.kavi.cz

# Datab√°ze
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=kavi_new
DB_USERNAME=kavi_user
DB_PASSWORD=tvoje-silne-heslo

# Email (pou≈æij sv√© Mailgun √∫daje)
MAIL_MAILER=smtp
MAIL_HOST=smtp.eu.mailgun.org
MAIL_PORT=587
MAIL_USERNAME=postmaster@mg.kavi.cz
MAIL_PASSWORD=tvoje-mailgun-heslo
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="objednavky@kavi.cz"
MAIL_FROM_NAME="Kavi"

MAILGUN_DOMAIN=mg.kavi.cz
MAILGUN_SECRET=tvuj-mailgun-api-key
MAILGUN_ENDPOINT=api.eu.mailgun.net

# Stripe (pou≈æij LIVE kl√≠ƒçe pro produkci!)
STRIPE_KEY=pk_live_...
STRIPE_SECRET=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Packeta
PACKETA_API_KEY=tvuj-api-key
PACKETA_API_PASSWORD=tvoje-heslo

# Fakturoid
FAKTUROID_CLIENT_ID=tvuj-client-id
FAKTUROID_CLIENT_SECRET=tvuj-secret
FAKTUROID_SLUG=tvuj-slug
FAKTUROID_NUMBER_FORMAT=
FAKTUROID_USER_AGENT="Kavi (info@kavi.cz)"
```

### 3.3 Generov√°n√≠ kl√≠ƒçe a nastaven√≠

```bash
cd /var/www/new.kavi.cz

# Generov√°n√≠ APP_KEY
php artisan key:generate

# Spu≈°tƒõn√≠ migrac√≠
php artisan migrate --force

# Cache optimalizace
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Vytvo≈ôen√≠ symbolic link pro storage
php artisan storage:link
```

### 3.4 Nastaven√≠ opr√°vnƒõn√≠

```bash
cd /var/www/new.kavi.cz

# Nastaven√≠ vlastn√≠ka
chown -R www-data:www-data /var/www/new.kavi.cz

# Nastaven√≠ opr√°vnƒõn√≠
chmod -R 755 /var/www/new.kavi.cz
chmod -R 775 /var/www/new.kavi.cz/storage
chmod -R 775 /var/www/new.kavi.cz/bootstrap/cache

# Vytvo≈ôen√≠ adres√°≈ô≈Ø pokud neexistuj√≠
mkdir -p storage/app/public/images
mkdir -p storage/app/invoices
chmod -R 775 storage/app
```

---

## üåê F√°ze 4: Konfigurace Nginx

### 4.1 Vytvo≈ôen√≠ Nginx konfigurace pro new.kavi.cz

```bash
nano /etc/nginx/sites-available/new.kavi.cz
```

Obsah konfigurace:

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name new.kavi.cz;
    
    # P≈ôesmƒõrov√°n√≠ na HTTPS (po z√≠sk√°n√≠ SSL)
    # return 301 https://$server_name$request_uri;

    root /var/www/new.kavi.cz/public;
    index index.php index.html index.htm;

    # Logov√°n√≠
    access_log /var/log/nginx/new.kavi.cz-access.log;
    error_log /var/log/nginx/new.kavi.cz-error.log;

    # Limity
    client_max_body_size 20M;

    # Hlavn√≠ location blok
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP handling
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        
        # Timeouts pro Stripe webhooks
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }

    # Statick√© soubory
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Bezpeƒçnost - deny p≈ô√≠stup k citliv√Ωm soubor≈Øm
    location ~ /\.(?!well-known).* {
        deny all;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # Deny p≈ô√≠stup k vendor a dal≈°√≠m adres√°≈ô≈Øm
    location ~ ^/(vendor|storage|database|tests|bootstrap|config|routes|app) {
        deny all;
        return 404;
    }
}
```

### 4.2 Aktivace konfigurace

```bash
# Vytvo≈ôen√≠ symbolick√©ho linku
ln -s /etc/nginx/sites-available/new.kavi.cz /etc/nginx/sites-enabled/

# Testov√°n√≠ konfigurace
nginx -t

# Restart Nginx
systemctl restart nginx
```

---

## üîí F√°ze 5: SSL certifik√°t (Let's Encrypt)

### 5.1 Instalace Certbot

```bash
apt install certbot python3-certbot-nginx -y
```

### 5.2 DNS konfigurace

**‚ö†Ô∏è D≈ÆLE≈ΩIT√â: P≈ôed z√≠sk√°n√≠m SSL mus√≠≈° nastavit DNS!**

V Hostinger DNS panelu (nebo kde m√°≈° DNS):
1. P≈ôidej A z√°znam:
   - **Typ:** A
   - **Host:** new
   - **IP:** IP adresa tv√©ho VPS serveru
   - **TTL:** 14400 (nebo v√Ωchoz√≠)

Poƒçkej 5-10 minut na propagaci DNS a ovƒõ≈ô:
```bash
ping new.kavi.cz
nslookup new.kavi.cz
```

### 5.3 Z√≠sk√°n√≠ SSL certifik√°tu

```bash
# Z√≠sk√°n√≠ certifik√°tu
certbot --nginx -d new.kavi.cz

# Automatick√© obnoven√≠ (nastav√≠ se automaticky)
certbot renew --dry-run
```

Certbot automaticky uprav√≠ tvou Nginx konfiguraci a p≈ôid√° HTTPS.

---

## üîê F√°ze 6: Zabezpeƒçen√≠

### 6.1 Firewall (UFW)

```bash
# Instalace a nastaven√≠
apt install ufw -y
ufw default deny incoming
ufw default allow outgoing

# Povolen√≠ slu≈æeb
ufw allow ssh
ufw allow 'Nginx Full'
ufw allow 3306  # MySQL (pouze pokud pot≈ôebuje≈° vzd√°len√Ω p≈ô√≠stup)

# Aktivace
ufw enable
ufw status
```

### 6.2 Zabezpeƒçen√≠ MySQL

```bash
# Pokud je≈°tƒõ nebylo spu≈°tƒõno
mysql_secure_installation
```

### 6.3 Fail2Ban (ochrana p≈ôed brute-force)

```bash
apt install fail2ban -y

# Vytvo≈ôen√≠ konfigurace pro Nginx
cat > /etc/fail2ban/jail.local << EOF
[nginx-http-auth]
enabled = true
filter = nginx-http-auth
port = http,https
logpath = /var/log/nginx/error.log

[nginx-limit-req]
enabled = true
filter = nginx-limit-req
port = http,https
logpath = /var/log/nginx/error.log
EOF

systemctl restart fail2ban
```

---

## üéØ F√°ze 7: Webhooks a Integrace

### 7.1 Stripe Webhook

V Stripe Dashboard (https://dashboard.stripe.com/webhooks):

1. P≈ôidej nov√Ω webhook endpoint:
   ```
   https://new.kavi.cz/stripe/webhook
   ```

2. Vyber tyto ud√°losti:
   - `checkout.session.completed`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`

3. Zkop√≠ruj webhook signing secret a p≈ôidej do `.env`:
   ```env
   STRIPE_WEBHOOK_SECRET=whsec_...
   ```

### 7.2 Mailgun DNS

Ujisti se, ≈æe m√°≈° v DNS spr√°vnƒõ nastaven√© Mailgun z√°znamy pro `mg.kavi.cz` nebo `kavi.cz`:
- SPF
- DKIM
- CNAME tracking records

### 7.3 Packeta API

Ovƒõ≈ô, ≈æe API kl√≠ƒçe v `.env` jsou spr√°vn√© a testuj na staging prost≈ôed√≠.

---

## ‚úÖ F√°ze 8: Testov√°n√≠

### 8.1 Z√°kladn√≠ kontroly

```bash
# Zkontroluj logov√°n√≠
tail -f /var/log/nginx/new.kavi.cz-error.log
tail -f /var/www/new.kavi.cz/storage/logs/laravel.log

# Zkontroluj PHP-FPM
systemctl status php8.2-fpm

# Zkontroluj Nginx
systemctl status nginx

# Zkontroluj MySQL
systemctl status mysql
```

### 8.2 Checklist testov√°n√≠

- [ ] Otev≈ô√≠t https://new.kavi.cz - zobraz√≠ se homepage
- [ ] Registrace nov√©ho u≈æivatele
- [ ] P≈ôihl√°≈°en√≠
- [ ] Proch√°zen√≠ produkt≈Ø
- [ ] P≈ôid√°n√≠ produktu do ko≈°√≠ku
- [ ] Checkout proces
- [ ] **Testovac√≠ platba** p≈ôes Stripe (pou≈æij test kartu: 4242 4242 4242 4242)
- [ ] Email potvrzen√≠ objedn√°vky
- [ ] Admin panel p≈ô√≠stup
- [ ] Vytvo≈ôen√≠ p≈ôedplatn√©ho
- [ ] Newsletter subscription
- [ ] Magic login link

### 8.3 Monitorov√°n√≠ v√Ωkonu

```bash
# Instalace htop pro monitoring
apt install htop -y

# Kontrola vyu≈æit√≠ zdroj≈Ø
htop

# Kontrola disk space
df -h

# Kontrola MySQL
mysql -u kavi_user -p kavi_new -e "SHOW TABLES;"
```

---

## üîÑ F√°ze 9: √ödr≈æba a aktualizace

### 9.1 Deployment skript

Vytvo≈ô si deployment skript pro snadn√© aktualizace:

```bash
nano /var/www/new.kavi.cz/deploy.sh
```

```bash
#!/bin/bash

echo "üöÄ Starting deployment..."

cd /var/www/new.kavi.cz

# Zapnut√≠ maintenance mode
php artisan down

# Git pull (pokud pou≈æ√≠v√°≈° Git)
git pull origin main

# Update z√°vislost√≠
composer install --optimize-autoloader --no-dev

# NPM build
npm install
npm run build

# Migrace datab√°ze
php artisan migrate --force

# Clear & cache
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Vypnut√≠ maintenance mode
php artisan up

echo "‚úÖ Deployment complete!"
```

```bash
chmod +x /var/www/new.kavi.cz/deploy.sh
```

### 9.2 Z√°lohy datab√°ze

Automatick√© denn√≠ z√°lohy:

```bash
nano /root/backup-kavi.sh
```

```bash
#!/bin/bash

BACKUP_DIR="/root/backups/kavi"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Database backup
mysqldump -u kavi_user -p'tvoje-heslo' kavi_new > $BACKUP_DIR/kavi_new_$DATE.sql

# Delete backups older than 7 days
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete

echo "Backup completed: kavi_new_$DATE.sql"
```

```bash
chmod +x /root/backup-kavi.sh

# P≈ôidej do crontab (dennƒõ ve 2:00)
crontab -e
# P≈ôidej ≈ô√°dek:
0 2 * * * /root/backup-kavi.sh >> /var/log/kavi-backup.log 2>&1
```

### 9.3 Logrotate

```bash
nano /etc/logrotate.d/kavi
```

```
/var/www/new.kavi.cz/storage/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
}
```

---

## üéä F√°ze 10: P≈ôepnut√≠ na produkci (po testov√°n√≠)

A≈æ bude≈° spokojen s testov√°n√≠m na `new.kavi.cz`, m≈Ø≈æe≈° p≈ôepnout na `kavi.cz`:

### 10.1 Z√°loha WordPressu

```bash
# Z√°lohuj st√°vaj√≠c√≠ WordPress
cp -r /var/www/kavi.cz /var/www/kavi.cz.wordpress-backup
```

### 10.2 DNS zmƒõna

Mo≈ænosti:
- **A) P≈ôejmenov√°n√≠:** P≈ôesu≈à Laravel na `kavi.cz` a WordPress na `old.kavi.cz`
- **B) Subdom√©na:** WordPress p≈ôesu≈à na `blog.kavi.cz`

### 10.3 Aktualizace Nginx

P≈ôejmenuj konfigurace:
```bash
mv /etc/nginx/sites-available/kavi.cz /etc/nginx/sites-available/old.kavi.cz
mv /etc/nginx/sites-available/new.kavi.cz /etc/nginx/sites-available/kavi.cz

# Uprav server_name v konfigurac√≠ch
nano /etc/nginx/sites-available/kavi.cz
# Zmƒõ≈à: server_name new.kavi.cz; ‚Üí server_name kavi.cz www.kavi.cz;
```

### 10.4 SSL pro novou dom√©nu

```bash
certbot --nginx -d kavi.cz -d www.kavi.cz
```

### 10.5 Aktualizace .env

```bash
nano /var/www/kavi.cz/.env
# Zmƒõ≈à APP_URL=https://kavi.cz
php artisan config:clear
php artisan config:cache
```

### 10.6 Aktualizace Stripe webhook

V Stripe Dashboard zmƒõ≈à webhook URL z `new.kavi.cz` na `kavi.cz`.

---

## üÜò Troubleshooting

### 500 Internal Server Error
```bash
# Zkontroluj logy
tail -100 /var/www/new.kavi.cz/storage/logs/laravel.log
tail -100 /var/log/nginx/new.kavi.cz-error.log

# Zkontroluj opr√°vnƒõn√≠
chown -R www-data:www-data /var/www/new.kavi.cz
chmod -R 775 storage bootstrap/cache
```

### Probl√©my s datab√°z√≠
```bash
# Otestuj p≈ôipojen√≠
php artisan tinker
>>> DB::connection()->getPdo();
```

### Assets se nenaƒç√≠taj√≠
```bash
cd /var/www/new.kavi.cz
npm run build
php artisan storage:link
```

### Email nefunguje
```bash
# Testovac√≠ email
php artisan tinker
>>> Mail::raw('Test email', function($msg) { $msg->to('tvuj@email.cz')->subject('Test'); });
```

---

## üìû Kontakty a zdroje

- **Laravel Docs:** https://laravel.com/docs/10.x
- **Stripe Docs:** https://stripe.com/docs
- **Mailgun Docs:** https://documentation.mailgun.com/
- **Certbot:** https://certbot.eff.org/

---

## üéâ Hotovo!

Teƒè m√°≈° bƒõ≈æ√≠c√≠:
- ‚úÖ `new.kavi.cz` - nov√° Laravel aplikace (staging/testov√°n√≠)
- ‚úÖ `kavi.cz` - st√°vaj√≠c√≠ WordPress (nedotƒçen√Ω)

Po d≈Økladn√©m testov√°n√≠ m≈Ø≈æe≈° p≈ôepnout na produkƒçn√≠ dom√©nu podle F√°ze 10.

**Pozn√°mky:**
- Pou≈æij LIVE API kl√≠ƒçe pro produkci (Stripe, Mailgun, Packeta, Fakturoid)
- Zapni backupy
- Monitoruj logy prvn√≠ t√Ωden
- Testuj v≈°echny platebn√≠ sc√©n√°≈ôe

Hodnƒõ ≈°tƒõst√≠ s nasazen√≠m! üöÄ

